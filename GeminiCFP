import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import java.util.*;
import java.util.concurrent.ConcurrentModificationException;
import java.util.function.Predicate;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static org.junit.jupiter.api.Assertions.*;

// Note: The actual PriorityQueue.java file from the openJDK (as provided by the user)
// must be compiled and accessible for these tests to run against it.
public class GeminiCFP {

    private PriorityQueue<Integer> pq;
    private Comparator<Integer> reverseOrder;

    @BeforeEach
    void setUp() {
        pq = new PriorityQueue<>();
        // Comparator for reverse natural ordering (Max-Heap behavior)
        reverseOrder = Comparator.reverseOrder();
    }

    // --- CONSTRUCTOR TESTS ---

    /**
     * Tests: public PriorityQueue() (Uses default capacity and natural ordering)
     */
    @Test
    void testConstructor_Default() {
        assertNotNull(pq);
        assertEquals(0, pq.size());
        assertNull(pq.comparator(), "Should use natural ordering (null comparator)");
    }

    /**
     * Tests: public PriorityQueue(int initialCapacity)
     */
    @Test
    void testConstructor_InitialCapacity() {
        pq = new PriorityQueue<>(5);
        assertEquals(0, pq.size());
        assertNull(pq.comparator());

        // Test capacity check (implicitly ensures the constructor branch is covered)
        assertThrows(IllegalArgumentException.class, () -> new PriorityQueue<>(0));
        assertThrows(IllegalArgumentException.class, () -> new PriorityQueue<>(-1));
    }

    /**
     * Tests: public PriorityQueue(Comparator<? super E> comparator)
     */
    @Test
    void testConstructor_ComparatorOnly() {
        pq = new PriorityQueue<>(reverseOrder);
        assertEquals(0, pq.size());
        assertNotNull(pq.comparator());

        // Test with null comparator (should default to natural ordering)
        pq = new PriorityQueue<>((Comparator<Integer>) null);
        assertNull(pq.comparator());
    }

    /**
     * Tests: public PriorityQueue(int initialCapacity, Comparator<? super E> comparator)
     * (Covers the primary constructor, which is called by the others)
     */
    @Test
    void testConstructor_CapacityAndComparator() {
        pq = new PriorityQueue<>(5, reverseOrder);
        assertEquals(0, pq.size());
        assertNotNull(pq.comparator());

        // Test insertion to ensure comparator is respected (implicitly tests siftUpUsingComparator)
        pq.add(10);
        pq.add(20);
        pq.add(5);
        assertEquals(20, pq.peek()); // Max element should be at head
    }

    /**
     * Tests: public PriorityQueue(Collection<? extends E> c)
     * (Covers initFromCollection and heapify)
     */
    @Test
    void testConstructor_FromCollection_Unsorted() {
        List<Integer> list = Arrays.asList(5, 1, 9, 3, 7);
        pq = new PriorityQueue<>(list); // Natural ordering (Min-Heap)
        assertEquals(5, pq.size());

        // Check if heap invariant is established (implicitly tests heapify and poll/siftDownComparable)
        assertEquals(1, pq.poll());
        assertEquals(3, pq.poll());
        assertEquals(5, pq.poll());
        assertEquals(7, pq.poll());
        assertEquals(9, pq.poll());
    }

    /**
     * Tests: public PriorityQueue(PriorityQueue<? extends E> c)
     * (Covers initFromPriorityQueue for same class)
     */
    @Test
    void testConstructor_FromPriorityQueue_SameClass() {
        PriorityQueue<Integer> source = new PriorityQueue<>(reverseOrder);
        source.add(10);
        source.add(20);
        source.add(5);

        pq = new PriorityQueue<>(source);
        assertEquals(3, pq.size());
        assertEquals(reverseOrder, pq.comparator());

        // Check content and ordering
        assertEquals(20, pq.poll());
        assertEquals(10, pq.poll());
        assertEquals(5, pq.poll());
    }

    /**
     * Tests: public PriorityQueue(SortedSet<? extends E> c)
     * (Covers initElementsFromCollection)
     */
    @Test
    void testConstructor_FromSortedSet() {
        SortedSet<Integer> sortedSet = new TreeSet<>(Arrays.asList(8, 2, 6));
        pq = new PriorityQueue<>(sortedSet); // Natural ordering by default
        assertEquals(3, pq.size());
        assertNull(pq.comparator());

        // Check content (heapified)
        assertEquals(2, pq.poll());
        assertEquals(6, pq.poll());
        assertEquals(8, pq.poll());
    }


    // --- INSERTION AND RETRIEVAL TESTS ---

    /**
     * Tests: public boolean add(E e) (Calls offer)
     */
    @Test
    void testAdd() {
        assertTrue(pq.add(5));
        assertEquals(1, pq.size());
        assertEquals(5, pq.peek());
    }

    /**
     * Tests: public boolean offer(E e) (Covers siftUpComparable and grow)
     */
    @Test
    void testOffer_MinHeap_SiftUp() {
        // Initial capacity 11 (DEFAULT_INITIAL_CAPACITY), 
        // Force growth to test private grow() and siftUpComparable
        for (int i = 0; i < 11; i++) {
            pq.offer(11 - i); // Inserts 11 down to 1
        }
        assertEquals(11, pq.peek()); // Last element inserted is at the head for a moment

        // Offer the smallest element to trigger SiftUp all the way to the root
        pq.offer(0); // Triggers grow() as capacity is reached (11th element is at index 10)

        // The smallest element must now be at the head
        assertEquals(12, pq.size());
        assertEquals(0, pq.peek());
        assertEquals(0, pq.poll()); // The structure is a valid min-heap
    }

    /**
     * Tests: public E peek()
     */
    @Test
    void testPeek() {
        assertNull(pq.peek(), "Peek on empty queue should return null");
        pq.offer(10);
        assertEquals(10, pq.peek());
        assertEquals(1, pq.size(), "Peek shouldn't remove the element");
    }

    /**
     * Tests: public E poll() (Covers siftDownComparable)
     */
    @Test
    void testPoll_MinHeap_SiftDown() {
        pq.offer(5);
        pq.offer(1);
        pq.offer(10);
        pq.offer(3); // [1, 3, 10, 5] (conceptual heap)

        assertEquals(1, pq.poll(), "Should remove the smallest element"); // Triggers siftDownComparable
        assertEquals(3, pq.poll());
        assertEquals(5, pq.poll());
        assertEquals(10, pq.poll());
        assertNull(pq.poll(), "Poll on empty queue should return null");
        assertEquals(0, pq.size());
    }

    /**
     * Tests: offer and poll with Comparator (Covers siftUpUsingComparator and siftDownUsingComparator)
     */
    @Test
    void testOfferAndPoll_MaxHeap_UsingComparator() {
        pq = new PriorityQueue<>(reverseOrder);
        pq.offer(5);
        pq.offer(1);
        pq.offer(10);
        pq.offer(3); // [10, 5, 1, 3] (conceptual heap)

        assertEquals(10, pq.poll(), "Should remove the largest element"); // Triggers siftDownUsingComparator
        assertEquals(5, pq.poll());
        assertEquals(3, pq.poll());
        assertEquals(1, pq.poll());
    }


    // --- REMOVAL AND SEARCH TESTS ---

    /**
     * Tests: public boolean contains(Object o) (Covers indexOf)
     */
    @Test
    void testContains() {
        pq.offer(5);
        pq.offer(10);
        pq.offer(15);
        assertTrue(pq.contains(10));
        assertFalse(pq.contains(20));
        assertFalse(pq.contains(null), "Should not contain nulls"); // Null not permitted
    }

    /**
     * Tests: public boolean remove(Object o) (Covers indexOf and removeAt)
     */
    @Test
    void testRemove_MiddleElement() {
        pq.offer(10);
        pq.offer(5);
        pq.offer(15);
        pq.offer(1); // [1, 5, 15, 10]

        // Remove element 10 (at index 3 in this case)
        assertTrue(pq.remove(10));
        assertEquals(3, pq.size());
        assertFalse(pq.contains(10));

        // Check if heap invariant is maintained (implicitly tests removeAt and siftDown/siftUp)
        assertEquals(1, pq.poll());
        assertEquals(5, pq.poll());
        assertEquals(15, pq.poll());

        // Remove element 5 (at index 1 in this case, a non-leaf node)
        pq.offer(1);
        pq.offer(10);
        assertTrue(pq.remove(5)); // [1, 10]
        assertEquals(1, pq.poll());
        assertEquals(10, pq.poll());

        assertFalse(pq.remove(99), "Should return false if element not present");
    }

    /**
     * Tests: E removeAt(int i) - Private helper method
     */
    @Test
    void testRemoveAt_RootElement() {
        pq.offer(5);
        pq.offer(1);
        pq.offer(10); // [1, 5, 10]

        // Remove at index 0 (root) - Should behave like poll, but removeAt is internally
        // used by remove(Object) and poll.
        pq.poll(); // Test internal removal of the root

        assertEquals(2, pq.size());
        assertEquals(5, pq.peek());
    }

    /**
     * Tests: public void clear()
     */
    @Test
    void testClear() {
        pq.add(1);
        pq.add(2);
        pq.clear();
        assertEquals(0, pq.size());
        assertNull(pq.peek());
    }


    // --- ITERATION AND BULK OPERATIONS TESTS ---

    /**
     * Tests: public Iterator<E> iterator()
     */
    @Test
    void testIterator_Traversal() {
        List<Integer> elements = Arrays.asList(10, 5, 15, 1);
        pq.addAll(elements); // uses heapify

        Iterator<Integer> it = pq.iterator();
        Set<Integer> traversed = new HashSet<>();
        while (it.hasNext()) {
            traversed.add(it.next());
        }

        assertEquals(new HashSet<>(elements), traversed, "Iterator should traverse all elements, regardless of order");
    }

    /**
     * Tests: Iterator remove method (Covers Itr.remove and removeAt/removeEq)
     */
    @Test
    void testIterator_Remove() {
        pq.offer(10);
        pq.offer(5);
        pq.offer(15); // [5, 10, 15]

        Iterator<Integer> it = pq.iterator();
        it.next(); // 5
        it.remove(); // Removes 5 (triggers removeAt or removeEq)

        assertEquals(2, pq.size());
        assertEquals(10, pq.peek(), "Heap invariant must be maintained after iterator removal");
        assertFalse(pq.contains(5));

        // Check for required exception
        assertThrows(IllegalStateException.class, it::remove, "Remove called without next()");
    }

    /**
     * Tests: Concurrent Modification Exception
     */
    @Test
    void testIterator_ConcurrentModification() {
        pq.offer(10);
        pq.offer(5);

        Iterator<Integer> it = pq.iterator();
        it.next(); // Traverses 10
        pq.offer(1); // Modifies the structure
        assertThrows(ConcurrentModificationException.class, it::next, "Should fail on next()");
    }

    /**
     * Tests: public <T> T[] toArray(T[] a)
     */
    @Test
    void testToArray_SpecificType() {
        pq.offer(10);
        pq.offer(5);

        Integer[] arr = pq.toArray(new Integer[0]);
        assertEquals(2, arr.length);
        assertTrue(Arrays.asList(arr).contains(5));
        assertTrue(Arrays.asList(arr).contains(10));

        Integer[] smallArr = new Integer[1];
        Integer[] newArr = pq.toArray(smallArr); // Should create a new array
        assertNotSame(smallArr, newArr);

        Integer[] largeArr = new Integer[3];
        largeArr[2] = 999;
        Integer[] existingArr = pq.toArray(largeArr); // Should use existing array and set excess to null
        assertSame(largeArr, existingArr);
        assertNull(existingArr[2]);
    }

    /**
     * Tests: public Object[] toArray()
     */
    @Test
    void testToArray_ObjectArray() {
        pq.offer(1);
        Object[] arr = pq.toArray();
        assertEquals(1, arr.length);
        assertEquals(1, arr[0]);
        assertNotSame(pq.queue, arr); // Should be a safe copy
    }

    /**
     * Tests: public boolean removeIf(Predicate<? super E> filter) (Covers bulkRemove)
     */
    @Test
    void testRemoveIf_BulkRemove() {
        pq.addAll(Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8, 9, 10));

        // Remove all even numbers
        Predicate<Integer> isEven = i -> i % 2 == 0;
        assertTrue(pq.removeIf(isEven));

        assertEquals(5, pq.size());
        // Remaining elements: 1, 3, 5, 7, 9 (and should be a valid heap)
        assertEquals(1, pq.poll());
        assertEquals(3, pq.poll());
        assertEquals(5, pq.poll());
        assertEquals(7, pq.poll());
        assertEquals(9, pq.poll());

        assertThrows(NullPointerException.class, () -> pq.removeIf(null));
    }

    /**
     * Tests: public boolean removeAll(Collection<?> c) (Covers bulkRemove)
     */
    @Test
    void testRemoveAll_BulkRemove() {
        pq.addAll(Arrays.asList(10, 20, 30, 40));
        List<Integer> toRemove = Arrays.asList(20, 40, 50);

        assertTrue(pq.removeAll(toRemove));
        assertEquals(2, pq.size());
        assertEquals(10, pq.poll());
        assertEquals(30, pq.poll());

        assertFalse(pq.removeAll(toRemove), "Should return false if no elements are removed");
    }

    /**
     * Tests: public boolean retainAll(Collection<?> c) (Covers bulkRemove)
     */
    @Test
    void testRetainAll_BulkRemove() {
        pq.addAll(Arrays.asList(10, 20, 30, 40));
        List<Integer> toRetain = Arrays.asList(20, 40, 50);

        assertTrue(pq.retainAll(toRetain));
        assertEquals(2, pq.size());
        // The retained elements are 20 and 40. Since 20 is smaller, it's the head.
        assertEquals(20, pq.poll());
        assertEquals(40, pq.poll());

        assertFalse(pq.retainAll(toRetain), "Should return false if no elements are removed");
    }

    /**
     * Tests: public void forEach(Consumer<? super E> action)
     */
    @Test
    void testForEach() {
        pq.addAll(Arrays.asList(1, 2, 3));
        Set<Integer> visited = new HashSet<>();
        pq.forEach(visited::add);

        assertEquals(Set.of(1, 2, 3), visited);
    }


    // --- OTHER PUBLIC METHODS ---

    /**
     * Tests: public int size()
     */
    @Test
    void testSize() {
        assertEquals(0, pq.size());
        pq.add(1);
        assertEquals(1, pq.size());
        pq.poll();
        assertEquals(0, pq.size());
    }

    /**
     * Tests: public Comparator<? super E> comparator()
     */
    @Test
    void testComparator() {
        assertNull(pq.comparator());

        pq = new PriorityQueue<>(reverseOrder);
        assertEquals(reverseOrder, pq.comparator());
    }

    /**
     * Tests: public Spliterator<E> spliterator()
     */
    @Test
    void testSpliterator() {
        pq.addAll(Arrays.asList(1, 2, 3, 4, 5));
        Spliterator<Integer> spliterator = pq.spliterator();

        assertTrue(spliterator.hasCharacteristics(Spliterator.SIZED));
        assertTrue(spliterator.hasCharacteristics(Spliterator.SUBSIZED));
        assertTrue(spliterator.hasCharacteristics(Spliterator.NONNULL));
        assertFalse(spliterator.hasCharacteristics(Spliterator.ORDERED));

        assertEquals(5, spliterator.estimateSize());

        // Test trySplit
        Spliterator<Integer> split = spliterator.trySplit();
        assertNotNull(split);
        assertEquals(2, split.estimateSize()); // 5 -> 2 & 3 (approx)

        // Test remaining elements are processed
        List<Integer> list = Stream.of(spliterator, split)
                .flatMap(s -> StreamSupport.stream(s, false))
                .collect(Collectors.toList());

        assertEquals(5, list.size());
        assertTrue(list.containsAll(Arrays.asList(1, 2, 3, 4, 5)));
    }
}
